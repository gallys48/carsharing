# Carsharing — система аренды автомобилей
# Оглавление

- [Описание проекта](#Описание-проекта)
- [Запуск проекта](#Запуск-проекта)
- [Подключение к базе данных](#Подключение-к-базе-данных)
- [Функционал приложения](#Функционал-приложения)
- [Тесты приложения](#Тесты-приложения)
---
# Описание проекта
## Краткая сводка

В данном приложении машины арендуются посуточно. Пользователь может иметь только одну активную (или зарезервированную) аренду. При оформлении аренды первым делом происходит резерв автомобиля, если он доступен. После чего пользователю нужно будет внести полный платеж. Пока не произойдет полная оплата суммы аренды остается в резерве. После полной оплаты пользователю поступит сообщение о активации аренды.

У пользователя есть возможность продлить аренду на n-ое количество дней. В таком случае по окончанию аренды ему выставляется счёт с суммой доплаты.

Если пользователь возвращает арендованный автомобиль раньше указанного им срока, то идет перерасчет и оплачиваемые средства за неиспользованные дни возвращаются.

---
## Структура проекта
```markdown
carsharing/
├── docker-compose.yml
├── Dockerfile
├── images
│ ├── schema.png
├── sql/
│ ├── logic/
│ │ ├── customers_logic.sql
│ │ ├── cars_logic.sql
│ │ ├── rentals_logic.sql
│ │ ├── payments_logic.sql
│ │ └── schema.sql
│ ├── init.sql
├── tests/
│ ├── conftest.py
│ ├── test.cars.py
│ ├── test_customers.py
│ ├── test_rentals.py
│ └── test_payments.py
└── README.md
```

---
## Схема базы данных

![Схема БД](images/schema.png)

## Описание сущностей

Пользователь
-	id serial primary key, -- сурогатный ключ
-	fullname text not null, -- имя
-	phone varchar(10), -- телефон
-	email text not null, -- почта
-	created_at timestamp, -- время создания
-	updated_at timestamp, -- время обновления
-	sys_status int not null. -- системный статус

Машина
-	id serial primary key, -- сурогатный ключ
-	vin varchar(17) not null, -- идентификатор машины
- maker text not null, -- производитель
- model text not null, -- модель
-	color text, -- цвет
-	year int, -- год выпуска
-	daily_rate numeric(10,2) not null, -- дневная ставка
-	is_available boolean not null, -- достуность авто
-	created_at timestamp,-- время создания
-	updated_at timestamp, --время обновления
-	sys_status int not null. --системный статус

Аренда
-	id serial primary key, -- сурогатный ключ
-	customer_id int not null, -- id покупателя (внешний ключ)
-	car_id int not null, -- id машины (внешний ключ)
-	start_date date, -- дата начала аренды
-	expected_return_date date not null, -- дата окончания(предварительная)
-	actual_return_date date, -- дата окончания(по факту)
-	daily_rate numeric(10,2) not null, -- дневная ставка(по факту)
-	amount numeric(12,2), -- сколько нужно оплатить
-	total_amount numeric(12,2, -- сколько оплачено на данный момент
-	status rental_status not null, -- статус аренды (rental_status - отдельно созданный тип)
-	create_at timestamp, -- время создания
-	updated_at timestamp, -- время обновления

Оплата
-	id serial primary key, -- сурогатный ключ
-	rental_id int not null, -- id аренды (внешний ключ)
-	payments_date date not null, -- дата оплаты
-	amount numeric(10,2) not null -- количество внесенных средств
---

# Запуск проекта

## Требования

| Компонент | Версия |
|------------|--------|
| Docker | 20.10+ |
| Docker Compose | 2.0+ |
| Python | 3.12+ |
| DBeaver / psql | (для подключения к БД) |

Рекомендуется установить [Docker Desktop](https://www.docker.com/products/docker-desktop/).

---

## Запуск PostgreSQL в Docker

Собираем и запускаем контейнер с базой данных:

```bash
docker compose up -d --build
```

После запуска:

- создается схема carsharing;
- создаются все таблицы;
- создается вся бизнес-логика;
- выполняются тесты из папки tests.

---

## Подключение к базе данных

| Параметр | Значение |
|------------|--------|
| Host | localhost |
| Port | 5433 |
| Database | carsharing |
| User | postgres |
|Password| postgres |

Порт 5433 прокидывается на случай, если 5432 занят.

Можно подключиться через DBeaver или в терминале:

```bash
docker exec -it carsharing_db psql -U postgres -d carsharing
```
---
# Функционал приложения

## Основной функционал приложения

- Создание, изменение, удаление пользователя;
- Создание, изменение, удаление машины;
- Создание, продление, возврат аренды;
- Оплата аренды;
- Просмотр списка свободных для аренды машин.

Весь функционал реализован с помощью процедур.
Все процедуры и их описание находятся в папке sql в файлах с названием `'сущность'_logic.sql.`

Процедура выполняется командой `CALL`.

Например:
```sql
CALL carsharing.create_car('001', 'Toyota', 'Camry', 'Red', 2020, 2000);
```

Также было создано представление 'Список свободных для аренды машин'.

Посмотреть этот список можно следующей командой:
```sql
select 1 from carsharing.available_cars;
```

# Тесты приложения

Тесты запускаются автоматически при запуске контейнера.

Результаты тестов можно увидеть в консоли.

## Структура тестов

test_cars.py - создание, обновление, удаление машин

test_customers.py — создание, обновление, удаление клиентов

test_rentals.py — аренда, продление, возврат автомобиля

test_payments.py — оплата аренды, переплата, проверка сумм

conftest.py — фикстуры Pytest, очистка БД перед каждым тестом













































